#{extends 'main.html' /}
#{set 'title'}
	 &{'pictures'}
#{/set}

#{isMine}
	#{uploadToolbar/}
#{/isMine}
#{script '../lightbox/js/jquery.lightbox-0.5.min.js'/}
#{stylesheet '../lightbox/css/jquery.lightbox-0.5.css'/}
<style type="text/css">
td{
	text-align:center;
	width: 154px;
}
textarea{
	width:100%;
	height:26px;
}
.imgtd {
}
.captd {
	font-size:12px;
}
.infotd{
	font-size:11px;
}
#editor a,
.infotd a{	
	/*float:right;*/
}
#editor a:hover,
.infotd a:hover{
	background:#0ff;
}
.imgrow{
}
tr.caprow{
	height:12px;
}
tr.inforow{
	color:#212121;
}
</style>

<div style="clear:both">  
#{if offset > 0 }
  <div class="grid_3 alpha" style="display:inline;" id="prev">
	<a href="@{Photoz.photos().add('family',family.code).add('offset',offset-pageSize > 0? offset-pageSize:0)}">&{'PreviousPage'}</a>
  </div>
#{/if}
#{if totalCount> offset+pageSize}
  <div class="grid_3 omega float-right" style="display:inline;"  id="next">
	<a href="@{Photoz.photos().add('family',family.code).add('offset',offset+pageSize)}">&{'NextPage'}</a>
  </div>
#{/if}
</div>

<script>
function doedit(div){
	$(div).hide();
	$(div).parent().append("<div id='editor'><textarea width='100%'>"+$(div).text()+"</textarea><a href='#' onclick='doSave(this)'>&{'save'}</a><a onclick='cancelEdit(this)' href='#'>&{'cancel'}</a></div>");
}
function cancelEdit(bt){	
	$(bt).closest("div").hide();
	$(bt).closest("div").siblings("#cap").show()
}
function doSave(bt){
	var cap = $(bt).closest("div").find("textarea").val();
	divcap = $(bt).closest("div").siblings("#cap")
	divcap.show()
	divcap.html('updating')
	$.post('@{Photoz.caption()}', {id:divcap.attr('pid'),caption:cap}, function(ret){				
		$('div[pid='+ret.id+']').html(ret.caption)
	}, "json");	
	$(bt).closest("div").hide();
}
function deletePhoto(a){
	if(confirm('&{'AreYouSure'}')){
		var pid = $(a).closest('div').attr('vpid');
		$.post('@{Photoz.remove()}', {id:pid,family:'${family.code}'}, function(ret){				
			window.location.reload();
		}, "json");	
	}
	return false;
}
</script>

<table>
%{
	def imgrow = ""
	def caprow = ""
	def inforow = ""	
	def cols = 4
	photos.eachWithIndex(){photo,i->
		//println(i+":"+photo.id)
		if( i%cols ==0 ){
			imgrow+="<tr valign='bottom' class='imgrow'>"
			caprow+="<tr valign='top' class='caprow'>"
			inforow+="<tr valign='top' class='inforow'>"
		}	
		imgrow += "<td class='imgtd'><div class='imgbock'><a href='/${photo.prefPath}'><img src='/${photo.thumb2Path}' alt='${photo.caption}'/></a></div></td>"
		caprow += "<td class='captd'><div id='cap' onclick='doedit(this)' pid='${photo.id}'>${photo.caption}</div></td>"
		inforow += ("<td class='infotd'><div id='info' vpid='${photo.id}'>"
			+play.i18n.Messages.get('updatedAt')
			+"${photo.uploadAt.format('yyyy/mm/dd')}" )
			//+"<br/>"
}%
#{isMine}			
			#{set 'inforow'}
				${inforow}<a href='#' onclick='deletePhoto(this)' >&{'deletePhoto'}</a>
			#{/set}
#{/isMine}
%{
			 
			inforow += ( "<a href='"
			+ actionBridge.Photoz.viewPhoto().add('family',family.code).add('id',photo.id)
			+"'> "
			+play.i18n.Messages.get('viewPhoto')
			+"</a>"
			+"</div></td>")
		
		if((i+1) == photos.size()){
			if (i % cols != cols - 1){
				def lack = cols - ( i % cols ) - 1
				for( j = 0; j < lack; j++) {
					imgrow +="<td>&nbsp;</td>"
					caprow +="<td>&nbsp;</td>"
					inforow +="<td>&nbsp;</td>"			
				}
			} 
		}
		
		if( i%cols == cols - 1 || (i+1) == photos.size()){
			out.print(imgrow)
			out.print(caprow)
			out.print(inforow)
			imgrow = ""
			caprow = ""
			inforow = ""
		}
	}	
}%
</table>

<script type="text/javascript">
    $(function() {
        $('.imgbock a').lightBox({
        	overlayBgColor: '#FFF',
			overlayOpacity: 0.6,
			imageLoading: '/public/lightbox/images/lightbox-ico-loading.gif',
			imageBtnClose: '/public/lightbox/images/lightbox-btn-close.gif',
			imageBtnPrev: '/public/lightbox/images/lightbox-btn-prev.gif',
			imageBtnNext: '/public/lightbox/images/lightbox-btn-next.gif',
			imageBlank: '/public/lightbox/images/lightbox-blank.gif',
			containerResizeSpeed: 350
        });
    });
</script>
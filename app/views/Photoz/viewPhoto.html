#{extends 'main.html' /}
#{set 'title'}
	 &{'pictures'}
#{/set}

#{isMine}
#{script 'jquery.imgareaselect.comments.js'/}
#{script 'ui.core.js'/}
#{script 'ui.draggable.js'/}
#{script 'ui.resizable.js'/}
#{stylesheet 'imgareaselect-default.css'/}
#{stylesheet 'themes/base/ui.all.css'/}


<style type="text/css">
a{
	cursor:pointer;
}
td{
	text-align:center;
	width: 154px;
}
textarea{
	width:100%;
	height:26px;
}
.imgtd {
}
.captd {
}
.sayHello{
	background:0px;
}
.sayHello img{
	padding:0px;
	border:0px;
	background:none;
}
#sayHello a:hover{
	background:#0ff;
}
</style>

<script>
	function rotateLeft(id){
		$.post('@{Photoz.rotateLeft()}',{id:id},function(){			
			window.location.reload();
		})
	}
	function rotateRight(id){
		$.post('@{Photoz.rotateRight()}',{id:id},function(){			
			window.location.reload();
		})
	}
	function sayHello(id){
		var editor=$("#sayHello")		
		if(editor.is(':visible'))return;
		var tdpos = $("#imgtd").position();		
		editor.css('top',tdpos.top+'px')
		editor.css('left',tdpos.left+'px')		
		$("#imgtd").append(editor);
		editor.show();
		//
		editor.draggable();
		editor.find("#hello-img").resizable();
	}
	function cancelHello(a){
		var editor = $(a).closest('div')
		editor.hide();
		//editor.remove();		
		$('#hiddendiv').append(editor);
	}
	function saveHello(a,id){		
		var editor = $(a).closest('div')
		var helloimg = editor.find('#hello-img');		
		var epos = editor.position();
		//var ipos = helloimg.position();
		var td = $('#imgtd');
		var img = td.find('#photo');
		var tdpos = td.position();
		var content = editor.find("#content").val();
		$.post('@{Photoz.sayHello()}',{id:id,
			x:(epos.left-tdpos.left - (td.width()-img.width())/2),
			y:(epos.top-tdpos.top - 5),
			w:helloimg.width(),h:helloimg.height(),
			content:content},function(){			
			window.location.reload();
		});
	}
	function revert(id){
		$.post('@{Photoz.revert()}',{id:id},function(){
			window.location.reload();
		});
	}
</script>
<div id='hiddendiv' style='display:none'>
	<div id='sayHello' class='sayHello' style='display:none;position:absolute;width:120px;height:132px;'>		
		<img id='hello-img' src='/public/images/hello-lt.gif' style='width:120px;height:70px;'/>	
		<table style="120px;height:62px;margin:0px;border:0px;">
			<tr style="height:40px"><td style="border:0px;padding:0px"><textarea id="content">&{'sayHello'}</textarea></td></tr>
			<tr style="height:22px;"><td style="border:0px;padding:0px"><a onclick="saveHello(this,'${photo.id}')">&{'save'}</a><a  onclick="cancelHello(this)">&{'cancel'}</a></td></tr>
		</table>	
	</div>
</div>
#{/isMine}

<div style="clear:both">
	<a onclick="return fasle;" href='javascript:history.go(-1)'>&{'returnToList'}</a>
#{isMine}
	<a  onclick="rotateRight((${photo.id}))">&{'rotateRight'}</a>
	<a  onclick="rotateLeft((${photo.id}))">&{'rotateLeft'}</a>
	<a  onclick="sayHello((${photo.id}))">&{'sayHello'}</a>
	<a  onclick="revert((${photo.id}))">&{'revert'}</a>
#{/isMine}	
</div>

<table>
<tr>
<td id='' style='text-align:left'>
	<h3>&{photo.caption}</h3>
</td>
</tr>
<tr>
<td id='imgtd'>
	<img id='photo' src="/${photo.prefPath}"/>
</td>
</tr>
<tr>
<td id=''>
	&{photo.caption}
</td>
</tr>
</table>
<table>
<h4 style='color:red;font-style:bold;'>&{'Responses'}</h4>
#{list items:responses, as:'resp'}
<tr><td style='width:40px'>${resp.author.fullname}</td>
<td style='text-align:left'>
	<label >${resp.postedAt.format('yyyy/MMM/dd')}</label>	
	${resp.content}</p>
</td>
</tr>
#{/list}
</table>
<style>
form{
	border:0px;
	margin:0px;
	padding:0px;
}
</style>
#{isLogin}
<div style='width:400px'>
<h4 style='color:red'>&{'addYourResponse'}</h4>
#{form @Photoz.responses().add('id',photo.id).add('family',family.code)}    
	<p>
		<label for="content">&{'YourMessage'} </label>
        <textarea style='height:60px' name="content" id="content">${content}</textarea>
    </p>
    <p>
        <input class='button' type="submit" value="&{'SubmitYourComment'}" />
    </p>
#{/form}
</div>
#{/isLogin}
<script type="text/javascript"> 

</script>
